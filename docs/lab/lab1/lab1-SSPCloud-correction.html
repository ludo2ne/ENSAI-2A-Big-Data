<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Lab 1">

<title>Big Data - First steps with Spark</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Big Data</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-labs" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Labs</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-labs">    
        <li>
    <a class="dropdown-item" href="../../../docs/lab/lab-setup.html" rel="" target="">
 <span class="dropdown-text">Lab setup</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../docs/lab/lab0/lab0.html" rel="" target="">
 <span class="dropdown-text">Lab 0</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../docs/lab/lab1/lab1-SSPCloud.html" rel="" target="">
 <span class="dropdown-text">Lab 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../docs/lab/lab2/lab2-SSPCloud.html" rel="" target="">
 <span class="dropdown-text">Lab 2</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../docs/lab/lab3/lab3.html" rel="" target="">
 <span class="dropdown-text">Lab 3</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ludo2ne/ENSAI-2A-Big-Data" rel="" target="_blank"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#before-you-start" id="toc-before-you-start" class="nav-link active" data-scroll-target="#before-you-start">1. Before you start</a></li>
  <li><a href="#create-a-spark-session" id="toc-create-a-spark-session" class="nav-link" data-scroll-target="#create-a-spark-session">2. Create a Spark session</a></li>
  <li><a href="#first-steps-with-spark---data-importation" id="toc-first-steps-with-spark---data-importation" class="nav-link" data-scroll-target="#first-steps-with-spark---data-importation">3. First steps with Spark - Data importation</a>
  <ul class="collapse">
  <li><a href="#hands-on-1---data-importation" id="toc-hands-on-1---data-importation" class="nav-link" data-scroll-target="#hands-on-1---data-importation">‚úçHands-on 1 - Data importation</a></li>
  </ul></li>
  <li><a href="#data-frame-basic-manipulations" id="toc-data-frame-basic-manipulations" class="nav-link" data-scroll-target="#data-frame-basic-manipulations">4. Data frame basic manipulations</a>
  <ul class="collapse">
  <li><a href="#lazy-evaluation" id="toc-lazy-evaluation" class="nav-link" data-scroll-target="#lazy-evaluation">Lazy evaluation</a></li>
  <li><a href="#hands-on-2---data-frame-basic-manipulations" id="toc-hands-on-2---data-frame-basic-manipulations" class="nav-link" data-scroll-target="#hands-on-2---data-frame-basic-manipulations">‚úçHands-on 2 - Data frame basic manipulations</a></li>
  </ul></li>
  <li><a href="#basic-dataframe-column-manipulation" id="toc-basic-dataframe-column-manipulation" class="nav-link" data-scroll-target="#basic-dataframe-column-manipulation">5. Basic DataFrame column manipulation</a>
  <ul class="collapse">
  <li><a href="#hands-on-3---basic-dataframe-column-manipulation" id="toc-hands-on-3---basic-dataframe-column-manipulation" class="nav-link" data-scroll-target="#hands-on-3---basic-dataframe-column-manipulation">‚úçHands-on 3 - Basic DataFrame column manipulation</a></li>
  </ul></li>
  <li><a href="#advance-dataframe-column-manipulation" id="toc-advance-dataframe-column-manipulation" class="nav-link" data-scroll-target="#advance-dataframe-column-manipulation">6. Advance DataFrame column manipulation</a>
  <ul class="collapse">
  <li><a href="#array-manipulation" id="toc-array-manipulation" class="nav-link" data-scroll-target="#array-manipulation">Array manipulation</a></li>
  <li><a href="#user-defined-function" id="toc-user-defined-function" class="nav-link" data-scroll-target="#user-defined-function">User defined function</a></li>
  </ul></li>
  <li><a href="#aggregation-functions" id="toc-aggregation-functions" class="nav-link" data-scroll-target="#aggregation-functions">7. Aggregation functions</a>
  <ul class="collapse">
  <li><a href="#hands-on-6---aggregation-functions" id="toc-hands-on-6---aggregation-functions" class="nav-link" data-scroll-target="#hands-on-6---aggregation-functions">‚úçHands-on 6 - Aggregation functions</a></li>
  </ul></li>
  <li><a href="#grouping-functions" id="toc-grouping-functions" class="nav-link" data-scroll-target="#grouping-functions">8. Grouping functions</a>
  <ul class="collapse">
  <li><a href="#hands-on-7---grouping-functions" id="toc-hands-on-7---grouping-functions" class="nav-link" data-scroll-target="#hands-on-7---grouping-functions">‚úçHands-on 7 - Grouping functions</a></li>
  </ul></li>
  <li><a href="#spark-sql" id="toc-spark-sql" class="nav-link" data-scroll-target="#spark-sql">9. Spark SQL</a>
  <ul class="collapse">
  <li><a href="#hands-on-8---spark-sql" id="toc-hands-on-8---spark-sql" class="nav-link" data-scroll-target="#hands-on-8---spark-sql">‚úçHands-on 8 - Spark SQL</a></li>
  </ul></li>
  <li><a href="#delete-the-jupyter-pyspark-service" id="toc-delete-the-jupyter-pyspark-service" class="nav-link" data-scroll-target="#delete-the-jupyter-pyspark-service">10. Delete the Jupyter-pyspark service</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/ludo2ne/ENSAI-2A-Big-Data/blob/main/docs/lab/lab1/lab1-SSPCloud-correction.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/ludo2ne/ENSAI-2A-Big-Data/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">First steps with Spark</h1>
</div>

<div>
  <div class="description">
    Lab 1
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="before-you-start" class="level2">
<h2 class="anchored" data-anchor-id="before-you-start">1. Before you start</h2>
<ul>
<li><input type="checkbox">connect to <a href="https://datalab.sspcloud.fr/">SSPCloud</a>
<ul>
<li>if necessary, create an account with your ENSAI e-mail address</li>
</ul></li>
<li>Go to <code>Mes services</code>
<ul>
<li><input type="checkbox">Create a new service : <code>Jupyter-pyspark</code></li>
<li>Wait for a few seconds</li>
<li><input type="checkbox">Clic on <code>Copier le mot de passe</code> and then <code>Ouvrir le service</code></li>
<li><input type="checkbox">On the next page, paste it in the appropriate place and <code>Log in</code></li>
<li>You are now in your Jupyter service</li>
</ul></li>
<li><input type="checkbox">Import file named <code>lab1-SSPCloud.ipynb</code>
<ul class="task-list">
<li><input type="checkbox">open it and follow the instructions</li>
</ul></li>
</ul>
<section id="at-this-end-of-this-lab" class="level4">
<h4 class="anchored" data-anchor-id="at-this-end-of-this-lab">At this end of this lab</h4>
<ul class="task-list">
<li><input type="checkbox">Export your notebook
<ul>
<li>File &gt; Export Notebook As ‚Ä¶ &gt; Export Notebook To HTML</li>
</ul></li>
<li><input type="checkbox">Delete your Jupyter service !</li>
</ul>
</section>
</section>
<section id="create-a-spark-session" class="level2">
<h2 class="anchored" data-anchor-id="create-a-spark-session">2. Create a Spark session</h2>
<ul class="task-list">
<li><input type="checkbox">Execute the following two cells to initialize a Spark session.</li>
</ul>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> (SparkSession </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>         .builder</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>         <span class="co"># default url of the internally accessed Kubernetes API</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>         <span class="co"># (This Jupyter notebook service is itself a Kubernetes Pod)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>         .master(<span class="st">"k8s://https://kubernetes.default.svc:443"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Executors spark docker image: for simplicity reasons, this jupyter notebook is reused </span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>         .config(<span class="st">"spark.kubernetes.container.image"</span>, os.environ[<span class="st">'IMAGE_NAME'</span>])</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Name of the Kubernetes namespace</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>         .config(<span class="st">"spark.kubernetes.namespace"</span>, os.environ[<span class="st">'KUBERNETES_NAMESPACE'</span>])</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Allocated memory to the JVM</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Stay careful, by default, the Kubernetes pods has a higher limit which depends on other parameters.</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>         .config(<span class="st">"spark.executor.memory"</span>, <span class="st">"4g"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>         .config(<span class="st">"spark.kubernetes.driver.pod.name"</span>, os.environ[<span class="st">'KUBERNETES_POD_NAME'</span>])</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>         <span class="co"># dynamic allocation configuration</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>         .config(<span class="st">"spark.dynamicAllocation.enabled"</span>,<span class="st">"true"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>         .config(<span class="st">"spark.dynamicAllocation.initialExecutors"</span>,<span class="st">"1"</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>         .config(<span class="st">"spark.dynamicAllocation.minExecutors"</span>,<span class="st">"1"</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>         .config(<span class="st">"spark.dynamicAllocation.maxExecutors"</span>,<span class="st">"60"</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Ratio match the number of pods to create for a given number of parallel tasks </span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>         <span class="co"># (100 parallel, ratio of 1, one aims at 100 pods, with 0.5 it would be 50 pods)</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>         .config(<span class="st">"spark.dynamicAllocation.executorAllocationRatio"</span>,<span class="st">"1"</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>         .config(<span class="st">"spark.dynamicAllocation.shuffleTracking.enabled"</span>,<span class="st">"true"</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>         .getOrCreate()</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>spark</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">

            <div>
                <p><b>SparkSession - in-memory</b></p>
                
        <div>
            <p><b>SparkContext</b></p>

            <p><a href="http://jupyter-pyspark-180818-0.jupyter-pyspark-180818.user-ludo2ne.svc.cluster.local:4040">Spark UI</a></p>

            <dl>
              <dt>Version</dt>
                <dd><code>v3.5.0</code></dd>
              <dt>Master</dt>
                <dd><code>k8s://https://kubernetes.default.svc:443</code></dd>
              <dt>AppName</dt>
                <dd><code>pyspark-shell</code></dd>
            </dl>
        </div>
        
            </div>
        
</div>
</div>
</section>
<section id="first-steps-with-spark---data-importation" class="level2">
<h2 class="anchored" data-anchor-id="first-steps-with-spark---data-importation">3. First steps with Spark - Data importation</h2>
<p>Spark‚Äôs main object class is the DataFrame, which is a distributed table.<br>
It is analogous to R‚Äôs or Python (Pandas)‚Äôs data frames:</p>
<ul>
<li>one row represents an observation,</li>
<li>one column represents a variable.</li>
</ul>
<p>But contrary to R or Python, Spark‚Äôs DataFrames can be distributed over hundred of nodes.</p>
<p>Spark support multiple data formats, and multiple ways to load them.</p>
<ul>
<li>data format : csv, json, parquet (an open source column oriented format)</li>
<li>can read archive files</li>
<li>schema detection or user defined schema. For static data, like a json file, schema detection can be use with good results.</li>
</ul>
<p>Spark has multiple syntaxes to import data. Some are simple with no customisation, others are more complexes but you can specify options.</p>
<p>The simplest syntaxes to load a json or a csv file are :</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># JSON</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>json_df <span class="op">=</span> spark.read.json([location of the <span class="bu">file</span>])</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># csv</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>csv_df <span class="op">=</span> spark.read.csv([location of the <span class="bu">file</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In the future, you may consult the <a href="https://spark.apache.org/docs/latest/sql-data-sources.html">Data Source documentation</a> to have the complete description of Spark‚Äôs reading abilities.</p>
<p>The data you will use in this lab are real data from the twitter <a href="https://developer.twitter.com/en/docs/twitter-api/tweets/sampled-stream/introduction">sampled stream API</a> and <a href="https://developer.twitter.com/en/docs/twitter-api/tweets/filtered-stream/introduction">filtered stream API</a>. The tweets folder contains more than 50 files and more than 2 million tweets. The tweets was collected between the 14/04/2021 and the 18/04/2021. The total collection time was less than 10 hours.</p>
<hr>
<section id="hands-on-1---data-importation" class="level3">
<h3 class="anchored" data-anchor-id="hands-on-1---data-importation">‚úçHands-on 1 - Data importation</h3>
<ul class="task-list">
<li><input type="checkbox">Load the json file stored here : <code>s3a://ludo2ne/diffusion/tweets.jsonl.gz</code>
<ul class="task-list">
<li><input type="checkbox">Name you data frame <code>df_tweet</code></li>
<li><input type="checkbox">Use function <code>cache()</code> on the data frame. Caching is a performance optimization technique that allows you to persist an intermediate or final result of a computation in memory, reducing the need to recompute the data when it is accessed multiple time</li>
</ul>
<small> ‚öôÔ∏è This file is an a <code>JSONL</code> (JSON-line) format, which means that each line of it is a JSON object. A JSON object is just a Python dictionary or a JavaScript object and looks like this: <code>{ key1: value1, key2: ["array", "of", "many values]}</code>). This file has been compressed into a <code>GZ</code> archive, hence the <code>.jsonl.gz</code> ending. Also this file is not magically appearing in your S3 storage. It is hosted on one of your teacher‚Äôs bucket and has been made public, so that you can access it.</small></li>
</ul>
<p>It‚Äôs possible to load multiple file in a unique DataFrame. It‚Äôs useful when you have daily files and want to process them all. It‚Äôs the same syntax as the previous one, just specify a folder.</p>
<ul>
<li>If you meet some issue to load this file, you can load and use your own file :
<ul>
<li>In Onyxia, <code>mes fichiers</code></li>
<li>Load file <code>tweets.jsonl.gz</code></li>
<li>In Jupyter, read it using <code>s3a://&lt;user_name&gt;/tweets.jsonl.gz</code></li>
</ul></li>
</ul>
<div class="cell" data-tags="[]" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DataFrame creation</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df_tweet <span class="op">=</span> spark.read.json(<span class="st">"s3a://ludo2ne/diffusion/tweets.jsonl.gz"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># caching</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>df_tweet.cache()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>DataFrame[auteur: string, contenu: string, date_creation: string, entities: struct&lt;annotations:array&lt;struct&lt;end:bigint,normalized_text:string,probability:double,start:bigint,type:string&gt;&gt;,cashtags:array&lt;struct&lt;end:bigint,start:bigint,tag:string&gt;&gt;,hashtags:array&lt;struct&lt;end:bigint,start:bigint,tag:string&gt;&gt;,mentions:array&lt;struct&lt;end:bigint,id:string,start:bigint,username:string&gt;&gt;,urls:array&lt;struct&lt;description:string,display_url:string,end:bigint,expanded_url:string,images:array&lt;struct&lt;height:bigint,url:string,width:bigint&gt;&gt;,start:bigint,status:bigint,title:string,unwound_url:string,url:string&gt;&gt;&gt;, hashtags: array&lt;string&gt;, like_count: bigint, other: struct&lt;auteur_name:string&gt;, reply_count: bigint, retweet_count: bigint]</code></pre>
</div>
</div>
</section>
</section>
<section id="data-frame-basic-manipulations" class="level2">
<h2 class="anchored" data-anchor-id="data-frame-basic-manipulations">4. Data frame basic manipulations</h2>
<p>If DataFrames are immutable, they can however be <strong><em>transformed</em></strong> in other DataFrames, in the sense that a modified copy is returned.<br>
Such <strong>transformations</strong> include: filtering, sampling, dropping columns, selecting columns, adding new columns‚Ä¶</p>
<p>First, you can get information about the columns with:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df.columns       <span class="co"># get the column names</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df.schema        <span class="co"># get the column names and their respective type</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>df.printSchema() <span class="co"># same, but human-readable</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can select columns with the <code>select()</code> method. It takes as argument a list of column name. For example :</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df_with_less_columns <span class="op">=</span> df<span class="op">\</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  .select(<span class="st">"variable3"</span>,<span class="st">"variable_four"</span>,<span class="st">"variable-6"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Yes, you do need the ugly \ at the end of the line,</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># if you want to chain methods between lines in Python</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can get nested columns easily with :</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df.select(<span class="st">"parentField.nestedField"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To filter data you could use the <code>filter()</code> method. It take as input an expression that gets evaluated for each observation and should return a boolean. Sampling is performed with the <code>sample()</code> method. For example :</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df_with_less_rows <span class="op">=</span> df<span class="op">\</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  .sample(fraction<span class="op">=</span><span class="fl">0.001</span>)<span class="op">\</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">filter</span>(df.variable1<span class="op">==</span><span class="st">"value"</span>)<span class="op">\</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As said before your data are distributed over multiple nodes (executors) and data inside a node are split into partitions. Then each transformations will be run in parallel. They are called <em>narrow transformation</em> For example, to sample a DataFrame, Spark sample every partitions in parallel because sample all partition produce the sample DataFrame. For some transformations, like <code>groupBy()</code> it‚Äôs impossible, and it‚Äôs cannot be run in parallel.</p>
<p><img src="img/spark_exemple2_pipeline.png" style="zoom:50%;"></p>
<!-- take() collect() limit() first() show() -->
<!-- lien vers la doc https://spark.apache.org/docs/3.1.1/api/python/reference/pyspark.sql.html#dataframe-apis -->
<section id="lazy-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="lazy-evaluation">Lazy evaluation</h3>
<p>This is because Spark has what is known as <strong>lazy evaluation</strong>, in the sense that it will wait as much as it can before performing the actual computation. Said otherwise, when you run an instruction such as:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>tweet_author_hashtags <span class="op">=</span> df_tweet_big.select(<span class="st">"auteur"</span>,<span class="st">"hashtags"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>‚Ä¶ you are not executing anything! Rather, you are building an <strong>execution plan</strong>, to be realised later.</p>
<p>Spark is quite extreme in its laziness, since only a handful of methods called <strong>actions</strong>, by opposition to <strong>transformations</strong>, will trigger an execution. The most notable are:</p>
<ol type="1">
<li><code>collect()</code>, explicitly asking Spark to fetch the resulting rows instead of to lazily wait for more instructions,</li>
<li><code>take(n)</code>, asking for <code>n</code> first rows</li>
<li><code>first()</code>, an alias for <code>take(1)</code></li>
<li><code>show()</code> and <code>show(n)</code>, human-friendly alternatives</li>
<li><code>count()</code>, asking for the numbers of rows</li>
<li>all the ‚Äúwrite‚Äù methods (write on file, write to database), see <a href="https://spark.apache.org/docs/3.1.1/api/python/reference/pyspark.sql.html#input-and-output">here</a> for the list</li>
</ol>
<p><strong>This has advantages:</strong> on huge data, you don‚Äôt want to accidently perform a computation that is not needed. Also, Spark can optimize each <strong>stage</strong> of the execution in regard to what comes next. For instance, filters will be executed as early as possible, since it diminishes the number of rows on which to perform later operations. On the contrary, joins are very computation-intense and will be executed as late as possible. The resulting <strong>execution plan</strong> consists in a <strong>directed acyclic graph</strong> (DAG) that contains the tree of all required actions for a specific computation, ordered in the most effective fashion.</p>
<p><strong>This has also drawbacks.</strong> Since the computation is optimized for the end result, the intermediate stages are discarded by default. So if you need a DataFrame multiple times, you have to cache it in memory because if you don‚Äôt Spark will recompute it every single time.</p>
<hr>
</section>
<section id="hands-on-2---data-frame-basic-manipulations" class="level3">
<h3 class="anchored" data-anchor-id="hands-on-2---data-frame-basic-manipulations">‚úçHands-on 2 - Data frame basic manipulations</h3>
<ul class="task-list">
<li><input type="checkbox">How many rows have your two DataFrame ?</li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_tweet.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>100000</code></pre>
</div>
</div>
<ul class="task-list">
<li><input type="checkbox">Display columns names and then the schema</li>
</ul>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df_tweet.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>['auteur',
 'contenu',
 'date_creation',
 'entities',
 'hashtags',
 'like_count',
 'other',
 'reply_count',
 'retweet_count']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df_tweet.printSchema()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>root
 |-- auteur: string (nullable = true)
 |-- contenu: string (nullable = true)
 |-- date_creation: string (nullable = true)
 |-- entities: struct (nullable = true)
 |    |-- annotations: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- normalized_text: string (nullable = true)
 |    |    |    |-- probability: double (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |    |    |    |-- type: string (nullable = true)
 |    |-- cashtags: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |    |    |    |-- tag: string (nullable = true)
 |    |-- hashtags: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |    |    |    |-- tag: string (nullable = true)
 |    |-- mentions: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- id: string (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |    |    |    |-- username: string (nullable = true)
 |    |-- urls: array (nullable = true)
 |    |    |-- element: struct (containsNull = true)
 |    |    |    |-- description: string (nullable = true)
 |    |    |    |-- display_url: string (nullable = true)
 |    |    |    |-- end: long (nullable = true)
 |    |    |    |-- expanded_url: string (nullable = true)
 |    |    |    |-- images: array (nullable = true)
 |    |    |    |    |-- element: struct (containsNull = true)
 |    |    |    |    |    |-- height: long (nullable = true)
 |    |    |    |    |    |-- url: string (nullable = true)
 |    |    |    |    |    |-- width: long (nullable = true)
 |    |    |    |-- start: long (nullable = true)
 |    |    |    |-- status: long (nullable = true)
 |    |    |    |-- title: string (nullable = true)
 |    |    |    |-- unwound_url: string (nullable = true)
 |    |    |    |-- url: string (nullable = true)
 |-- hashtags: array (nullable = true)
 |    |-- element: string (containsNull = true)
 |-- like_count: long (nullable = true)
 |-- other: struct (nullable = true)
 |    |-- auteur_name: string (nullable = true)
 |-- reply_count: long (nullable = true)
 |-- retweet_count: long (nullable = true)
</code></pre>
</div>
</div>
<ul class="task-list">
<li><input type="checkbox">Display 10 rows of df_tweet</li>
</ul>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df_tweet.show(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 1:&gt;                                                          (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------+-------------------------------+--------------------+--------------------+--------+----------+--------------------+-----------+-------------+
|         auteur|                        contenu|       date_creation|            entities|hashtags|like_count|               other|reply_count|retweet_count|
+---------------+-------------------------------+--------------------+--------------------+--------+----------+--------------------+-----------+-------------+
|    xwendystian|           RT @karlarboledas...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|            {Wüö∂‚Äç‚ôÄÔ∏è}|          0|          962|
|    suoicilataR|           RT @sooky_co: SLA...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|               {Rat}|          0|         3849|
|        SatsuOW|           RT @kusujinn: üëª?...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|             {Satsu}|          0|         9787|
|   birashoboka7|           @Kitona_gold You ...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|       {birashoboka}|          0|            0|
|    TheRealCzia|           nagugulat ako don...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|{Czia is looking ...|          0|            0|
|      bbyindrii|           Keknya ni mata ha...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|                {üé†}|          0|            0|
|          9nns3|„Å™„Çì„ÅãÊ∑±Â§ú2~3ÊôÇ„ÅÆÊ∞óÂàÜ„Å†„Åã„ÇâÂØù„Çã|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|              {·í£·î∞üçê}|          0|            0|
|banbanzai__1140|   @banbanzai_ „Éû„Ç∏„Åß‰ºö„ÅÑ„Åü„ÅÑ„ÄÇ|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          {„ÇÑ„Åæ„ÇÇ„Çì}|          0|            0|
| Sampathreddyk6|           RT @ynakg2: When ...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|     {Sampathreddyk}|          0|          838|
|ElQueLosCritica|           Uy, el Centro cam...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|       {Don Critico}|          0|            0|
+---------------+-------------------------------+--------------------+--------------------+--------+----------+--------------------+-----------+-------------+
only showing top 10 rows
</code></pre>
</div>
</div>
<ul class="task-list">
<li><input type="checkbox">Sample <code>df_tweet</code> and keep only 10% of it.
<ul>
<li>Create a new DataFrame named <code>df_tweet_sampled</code>.</li>
<li>If computations take too long on the full DataFrame, use this one instead or add a sample transformation in your expression.</li>
</ul></li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df_tweet_sampled <span class="op">=</span> df_tweet<span class="op">\</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  .sample(fraction<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>df_tweet_sampled.count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>10145</code></pre>
</div>
</div>
<ul class="task-list">
<li><input type="checkbox">Define a DataFrame <code>tweet_author_hashtags</code> with only the <code>auteur</code> and <code>hashtags</code> columns
<ul class="task-list">
<li><input type="checkbox">Then display 5 rows</li>
</ul></li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>tweet_author_hashtags <span class="op">=</span> df_tweet.select(<span class="st">"auteur"</span>, <span class="st">"hashtags"</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>tweet_author_hashtags.show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------+--------+
|      auteur|hashtags|
+------------+--------+
| xwendystian|      []|
| suoicilataR|      []|
|     SatsuOW|      []|
|birashoboka7|      []|
| TheRealCzia|      []|
+------------+--------+
only showing top 5 rows
</code></pre>
</div>
</div>
<ul class="task-list">
<li><input type="checkbox">Print 5 lines of a <strong>df_tweet</strong> with only the <code>auteur</code>, <code>mentions</code>, and <code>urls</code> columns.
<ul>
<li><code>mentions</code> and <code>urls</code> are both nested columns in <code>entities</code></li>
</ul></li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  .select(<span class="st">"auteur"</span>, </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>          <span class="st">"entities.mentions"</span>, </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>          <span class="st">"entities.urls"</span>)<span class="op">\</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------+--------------------+--------------------+
|      auteur|            mentions|                urls|
+------------+--------------------+--------------------+
| xwendystian|[{17, 11851291015...|                NULL|
| suoicilataR|[{12, 14533927358...|[{NULL, pic.twitt...|
|     SatsuOW|[{12, 11935477705...|[{NULL, pic.twitt...|
|birashoboka7|[{12, 14860437391...|                NULL|
| TheRealCzia|                NULL|                NULL|
+------------+--------------------+--------------------+
only showing top 5 rows
</code></pre>
</div>
</div>
<ul class="task-list">
<li><input type="checkbox">Filter <strong>df_tweet</strong> and keep only tweets with more than 1 like.
<ul class="task-list">
<li><input type="checkbox">Display only <code>auteur</code>, <code>contenu</code> and <code>like_count</code></li>
<li><input type="checkbox">Print 10 lines</li>
</ul></li>
</ul>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">filter</span>(df_tweet.like_count <span class="op">&gt;=</span> <span class="dv">1</span>)<span class="op">\</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------+------------------------------------+--------------------+--------------------+---------+----------+--------------------------------+-----------+-------------+
|         auteur|                             contenu|       date_creation|            entities| hashtags|like_count|                           other|reply_count|retweet_count|
+---------------+------------------------------------+--------------------+--------------------+---------+----------+--------------------------------+-----------+-------------+
|      DZero_SYS|                @blueberry_lin üñ•...|2022-03-24T14:59:...|{NULL, NULL, NULL...|       []|         1|               {Ìè¨ÏºìÏõåÏπò ÏãúÏä§ÌÖú}|          0|            0|
|exusial_Penguin|            @Hano_Braves „Å∏„Åá„ÄÅ„ÅÑ...|2022-03-24T14:59:...|{NULL, NULL, NULL...|       []|         1|                      {„Ç®„ÇØ„Ç∑„Ç¢}|          0|            0|
|      queend236|                @dayytonerr I try...|2022-03-24T14:59:...|{NULL, NULL, NULL...|       []|         1|            {ungrateful house...|          0|            0|
|      ProBarron|                   ‚úã#Bitcoin forever|2022-03-24T14:59:...|{NULL, NULL, [{9,...|[Bitcoin]|         1|                        {Barron}|          0|            0|
|enaha1648133622|                Acting is happy a...|2022-03-24T14:59:...|{NULL, NULL, NULL...|       []|         1|              {vineethmintuüå∏üåπ}|          1|            0|
|rwyva1648133803|                Love does not alw...|2022-03-24T14:59:...|{NULL, NULL, NULL...|       []|         1|            {ÔªúŸïŸàŸêÿØŸíŸìŸã‚Ä¢ ‚ÄèÔ∫ßŸïŸìÿµŸçŸÖŸç}|          1|            0|
|        nhoyvck|                   @jenoleeader meee|2022-03-24T14:59:...|{NULL, NULL, NULL...|       []|         1|                             {Ÿã}|          0|            0|
|  Takajyura9_36|„Å°„Éº„Åº„Éº„ÄÅ„Åæ„Çä„ÅìP„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„Åü...|2022-03-24T14:59:...|{NULL, NULL, [{71...| [mp2000]|         1|                 {„Åü„Åã„Åò„ÇÖ„ÇâÔΩû‚òÜ}|          0|            0|
|       Nexion17|                @pizdets17 Even T...|2022-03-24T14:59:...|{[{22, Trudeau, 0...|       []|         1|                    {Trader Nex}|          0|            0|
|MyTomoya_030329|   ÎÆàÏßÄ? Ï†úÍ¥ëÍ∏∞Ïóê ÎÜÄÎùºÏÑú ÎëêÎ™ÖÏù¥ÎÇò...|2022-03-24T14:59:...|{NULL, NULL, NULL...|       []|         1|{Î∏åÎ†àÏù¥ÌÅ¨Îã§ÎÇò‚ù§Ô∏èÎ∏åÎ†àÏù¥ÌÅ¨Îã§ÎÇòüß°...|          0|            0|
+---------------+------------------------------------+--------------------+--------------------+---------+----------+--------------------------------+-----------+-------------+
only showing top 10 rows
</code></pre>
</div>
</div>
</section>
</section>
<section id="basic-dataframe-column-manipulation" class="level2">
<h2 class="anchored" data-anchor-id="basic-dataframe-column-manipulation">5. Basic DataFrame column manipulation</h2>
<p>You can add/update/rename column of a DataFrame using <strong>spark</strong> :</p>
<ul>
<li>Drop : <code>df.drop(columnName : str )</code></li>
<li>Rename : <code>df.withColumnRenamed(oldName : str, newName : str)</code></li>
<li>Add/update : <code>df.withColumn(columnName : str, columnExpression)</code></li>
</ul>
<p>For example</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  .withColumn(                                        <span class="co"># computes new variable</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"like_rt_ratio"</span>,                                  <span class="co"># like_rt_ratio "OVERCONFIDENCE"</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    df_tweet.like_count <span class="op">/</span>df_tweet.retweet_count)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>See <strong><a href="https://spark.apache.org/docs/3.1.1/api/python/reference/pyspark.sql.html#functions">here</a></strong> for the list of all functions available in an expression.</p>
<section id="hands-on-3---basic-dataframe-column-manipulation" class="level3">
<h3 class="anchored" data-anchor-id="hands-on-3---basic-dataframe-column-manipulation">‚úçHands-on 3 - Basic DataFrame column manipulation</h3>
<ul class="task-list">
<li><input type="checkbox">Define a DataFrame with a column names <code>interaction_count</code> named <code>df_tweet_interaction_count</code>
<ul>
<li>This column is the sum of <code>like_count</code>, <code>reply_count</code> and <code>retweet_count</code>.</li>
</ul></li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="17">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df_tweet_interaction_count <span class="op">=</span> df_tweet<span class="op">\</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  .drop(<span class="st">"other"</span>)<span class="op">\</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">filter</span>(df_tweet.like_count <span class="op">&gt;=</span> <span class="dv">1</span>)<span class="op">\</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">filter</span>(df_tweet.retweet_count <span class="op">&gt;=</span> <span class="dv">1</span>)<span class="op">\</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  .withColumn(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"interaction_count"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    df_tweet.like_count <span class="op">+</span> df_tweet.reply_count <span class="op">+</span> df_tweet.retweet_count)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>df_tweet_interaction_count<span class="op">\</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------+-------------------------------------+--------------------+---------------------------+--------------------------------+----------+-----------+-------------+-----------------+
|        auteur|                              contenu|       date_creation|                   entities|                        hashtags|like_count|reply_count|retweet_count|interaction_count|
+--------------+-------------------------------------+--------------------+---------------------------+--------------------------------+----------+-----------+-------------+-----------------+
|      Unif1992|                 kalƒ±pla≈ümƒ±≈ü #beyo...|2022-03-24T14:59:...|       {NULL, NULL, [{20...|                       [beyoƒülu]|         1|          0|            2|                3|
|    moonknight|                 The wait is almos...|2022-03-24T15:00:...|       {[{40, Marvel Stu...|                    [MoonKnight]|        16|          0|            2|               18|
|         B04Zw|                #PayPay\n#PayPay„É´...|2022-03-24T15:00:...|       {NULL, NULL, [{7,...|          [PayPay, PayPay„É´„Éº...|         2|          0|            1|                3|
|   SoulTide_JP|  #„ÇΩ„Ç¶„É´„Çø„Ç§„Éâ „É™„É™„Éº„ÇπË®òÂøµ„Ç≠„É£„É≥...|2022-03-24T15:00:...|       {NULL, NULL, [{7,...|  [„ÇΩ„Ç¶„É´„Çø„Ç§„Éâ, „Éï„Ç©„É≠„ÉºRT, ...|         3|          0|           20|               23|
|       strk1dz|                 happy 4th anniver...|2022-03-24T15:00:...|       {NULL, NULL, [{11...|[Ïä§ÌÇ§Ï¶àÏôÄ_Î∞úÎßûÏ∂∞Í±∑Îäî_4Î≤àÏß∏Í∏∏,...|         2|          0|            1|                3|
|  HALUKA_EIMIE| Â§ßÂ•Ω„Åç„Å™„Åä„Åò„Çá„ÅäË™ïÁîüÊó•„Åä„ÇÅ„Åß„Å®„ÅÜ?...|2022-03-24T15:00:...|       {NULL, NULL, NULL...|                              []|         2|          0|            1|                3|
|cubesugar03196|             Ê®ãÂè£ÂÜÜÈ¶ô https://t.co...|2022-03-24T15:00:...|       {NULL, NULL, NULL...|                              []|         2|          0|            1|                3|
|  hokuoukizoku| ÂåóÊ¨ßË≤¥Êóè„Å®ÁåõÁ¶ΩÂ¶ª„ÅÆÈõ™ÂõΩÁã©„ÇäÊöÆ„Çâ„Åó\...|2022-03-24T15:00:...|{[{45, „ÅÇ„Åã„Å≠„ÅìÂÖàÁîü 78Ë©±...|                              []|         1|          0|            1|                2|
|   iRis_a_himi|„Åø„Çì„Å™„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅËåúÂ±ã„Å°„ÇÉ„Éº„Çì„Å®ÂÖÉ...|2022-03-24T15:01:...|       {NULL, NULL, NULL...|                              []|        17|          0|            3|               20|
| tarun25812648|                 @ImRealScout Bro ...|2022-03-24T15:01:...|       {NULL, NULL, NULL...|                              []|         1|          0|            1|                2|
+--------------+-------------------------------------+--------------------+---------------------------+--------------------------------+----------+-----------+-------------+-----------------+
only showing top 10 rows
</code></pre>
</div>
</div>
<ul class="task-list">
<li><input type="checkbox">Update the DataFrame you imported at the beginning of this lab and drop the <code>other</code> column</li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  .drop(<span class="st">"other"</span>)<span class="op">\</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------+-------------------------------+--------------------+--------------------+--------+----------+-----------+-------------+
|         auteur|                        contenu|       date_creation|            entities|hashtags|like_count|reply_count|retweet_count|
+---------------+-------------------------------+--------------------+--------------------+--------+----------+-----------+-------------+
|    xwendystian|           RT @karlarboledas...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          0|          962|
|    suoicilataR|           RT @sooky_co: SLA...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          0|         3849|
|        SatsuOW|           RT @kusujinn: üëª?...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          0|         9787|
|   birashoboka7|           @Kitona_gold You ...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          0|            0|
|    TheRealCzia|           nagugulat ako don...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          0|            0|
|      bbyindrii|           Keknya ni mata ha...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          0|            0|
|          9nns3|„Å™„Çì„ÅãÊ∑±Â§ú2~3ÊôÇ„ÅÆÊ∞óÂàÜ„Å†„Åã„ÇâÂØù„Çã|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          0|            0|
|banbanzai__1140|   @banbanzai_ „Éû„Ç∏„Åß‰ºö„ÅÑ„Åü„ÅÑ„ÄÇ|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          0|            0|
| Sampathreddyk6|           RT @ynakg2: When ...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          0|          838|
|ElQueLosCritica|           Uy, el Centro cam...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          0|            0|
+---------------+-------------------------------+--------------------+--------------------+--------+----------+-----------+-------------+
only showing top 10 rows
</code></pre>
</div>
</div>
</section>
</section>
<section id="advance-dataframe-column-manipulation" class="level2">
<h2 class="anchored" data-anchor-id="advance-dataframe-column-manipulation">6. Advance DataFrame column manipulation</h2>
<section id="array-manipulation" class="level3">
<h3 class="anchored" data-anchor-id="array-manipulation">Array manipulation</h3>
<p>Some columns often contain arrays (lists) of values instead of just one value. This may seem surprising but this actually quite natural.<br>
For instance, you may create an array of words from a text, or generate a list of random numbers for each observation, etc.</p>
<p>You may <strong>create array of values</strong> with:</p>
<ul>
<li><code>split(text : string, delimiter : string)</code>, turning a text into an array of strings</li>
</ul>
<p>You may <strong>use array of values</strong> with:</p>
<ul>
<li><p><code>size(array : Array)</code>, getting the number of elements</p></li>
<li><p><code>array_contains(inputArray : Array, value : any)</code>, checking if some value appears</p></li>
<li><p><code>explode(array : Array)</code>, unnesting an array and duplicating other values. For instance if you use <code>explode()</code> over the hashtags value of this DataFrame:</p>
<table class="table">
<thead>
<tr class="header">
<th>Auteur</th>
<th>Contenu</th>
<th>Hashtags</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Bob</td>
<td>I love #Spark and #bigdata</td>
<td>[Spark, bigdata]</td>
</tr>
<tr class="even">
<td>Alice</td>
<td>Just finished #MHrise, best MH ever</td>
<td>[MHrise]</td>
</tr>
</tbody>
</table>
<p>You will get :</p>
<table class="table">
<colgroup>
<col style="width: 9%">
<col style="width: 54%">
<col style="width: 25%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th>Auteur</th>
<th>Contenu</th>
<th>Hashtags</th>
<th>Hashtag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Bob</td>
<td>I love #Spark and #bigdata</td>
<td>[Spark, bigdata]</td>
<td>Spark</td>
</tr>
<tr class="even">
<td>Bob</td>
<td>I love #Spark and #bigdata</td>
<td>[Spark, bigdata]</td>
<td>bigdata</td>
</tr>
<tr class="odd">
<td>Alice</td>
<td>Just finished #MHrise, best MH ever</td>
<td>[MHrise]</td>
<td>MHrise</td>
</tr>
</tbody>
</table></li>
</ul>
<p>All this functions must be imported first :</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> split, explode, size, array_contains</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Do not forget, to create a new column, you should use <code>withColumn()</code>. For example :</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df.withColumn(<span class="st">"new column"</span>, explode(<span class="st">"array"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="hands-on-4---array-manipulation" class="level4">
<h4 class="anchored" data-anchor-id="hands-on-4---array-manipulation">‚úçHands-on 4 - Array manipulation</h4>
<ul class="task-list">
<li><input type="checkbox">Keep all the tweets with hashtags and for each remaining line, split the hashtag text into an array of hashtags</li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> split, explode, size, array_contains</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">filter</span>(size(<span class="st">"hashtags"</span>) <span class="op">&gt;</span> <span class="dv">0</span>)<span class="op">\</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  .withColumn(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hashtag_exploded"</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    explode(<span class="st">"hashtags"</span>))<span class="op">\</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------+-----------------------+--------------------+----------------------------+---------------------+----------+--------------------+-----------+-------------+-----------------+
|      auteur|                contenu|       date_creation|                    entities|             hashtags|like_count|               other|reply_count|retweet_count| hashtag_exploded|
+------------+-----------------------+--------------------+----------------------------+---------------------+----------+--------------------+-----------+-------------+-----------------+
|     GIimoto|RT @aabbeecc: Êó•Êú¨„Ç≥...|2022-03-24T14:59:...|{[{21, Êó•Êú¨„Ç≥„Ç´„Éª„Ç≥„Éº„É©, ...|[utamaru, „Ç≥„Éº„ÇØ„Ç™„É≥]|         0|       {g.orchestra}|          0|            4|          utamaru|
|     GIimoto|RT @aabbeecc: Êó•Êú¨„Ç≥...|2022-03-24T14:59:...|{[{21, Êó•Êú¨„Ç≥„Ç´„Éª„Ç≥„Éº„É©, ...|[utamaru, „Ç≥„Éº„ÇØ„Ç™„É≥]|         0|       {g.orchestra}|          0|            4|       „Ç≥„Éº„ÇØ„Ç™„É≥|
|  MEWWhiskey|   üìç‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏≤‡∏£ nct dre...|2022-03-24T14:59:...|        {NULL, NULL, [{14...| [‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏înctdream,...|         0|{‚ô°‚Äß‚ÇäÀöùë±ùë±ùë¥ .‚óú‚ó°‚óù ...|          0|            0|  ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏înctdream|
|  MEWWhiskey|   üìç‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏≤‡∏£ nct dre...|2022-03-24T14:59:...|        {NULL, NULL, [{14...| [‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏înctdream,...|         0|{‚ô°‚Äß‚ÇäÀöùë±ùë±ùë¥ .‚óú‚ó°‚óù ...|          0|            0|       ‡∏ï‡∏•‡∏≤‡∏î‡∏ô‡∏±‡∏înct|
|     1Giga23|   RT @blackboy: ŸÜŸäÿß...|2022-03-24T14:59:...|        {NULL, NULL, [{37...| [ŸÖŸÑŸäŸàŸÜŸäÿ©24ŸÖÿßÿ±ÿ≥, ŸÖ...|         0|         {Giga Rawi}|          0|           10|    ŸÖŸÑŸäŸàŸÜŸäÿ©24ŸÖÿßÿ±ÿ≥|
|     1Giga23|   RT @blackboy: ŸÜŸäÿß...|2022-03-24T14:59:...|        {NULL, NULL, [{37...| [ŸÖŸÑŸäŸàŸÜŸäÿ©24ŸÖÿßÿ±ÿ≥, ŸÖ...|         0|         {Giga Rawi}|          0|           10|ŸÖÿØŸÜ_ÿßŸÑÿ≥ŸàÿØÿßŸÜ_ÿ™ŸÜÿ™ŸÅÿ∂|
|  XiynZeOrdo|   RT @AFP: #BREAKIN...|2022-03-24T14:59:...|        {[{83, Luhansk, 0...|           [BREAKING]|         0|{ORDO√Ñ üáØüá≤ üá∫üá¶ ...|          0|           30|         BREAKING|
|    clyennie|   @NJARCHIVED House...|2022-03-24T14:59:...|        {NULL, NULL, [{55...|    [Fluffy_Kuma_Day]|         0|                {‚âà‚âà}|          0|            0|  Fluffy_Kuma_Day|
|smithxgianna|   I can't wait to u...|2022-03-24T14:59:...|        {NULL, [{189, 185...| [Blockchain, NFT,...|         0|      {Gianna Smith}|          0|            0|       Blockchain|
|smithxgianna|   I can't wait to u...|2022-03-24T14:59:...|        {NULL, [{189, 185...| [Blockchain, NFT,...|         0|      {Gianna Smith}|          0|            0|              NFT|
+------------+-----------------------+--------------------+----------------------------+---------------------+----------+--------------------+-----------+-------------+-----------------+
only showing top 10 rows
</code></pre>
</div>
</div>
<ul class="task-list">
<li><input type="checkbox">Create a new column with the number of words of the <code>contenu</code> column. (Use <code>split()</code> + <code>size()</code>)</li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  .withColumn(<span class="st">"word_count"</span>, </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>              size(split(<span class="st">"contenu"</span>, <span class="st">" "</span>)))<span class="op">\</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------+--------------------+--------------------+--------------------+--------+----------+--------------------+-----------+-------------+----------+
|      auteur|             contenu|       date_creation|            entities|hashtags|like_count|               other|reply_count|retweet_count|word_count|
+------------+--------------------+--------------------+--------------------+--------+----------+--------------------+-----------+-------------+----------+
| xwendystian|RT @karlarboledas...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|            {Wüö∂‚Äç‚ôÄÔ∏è}|          0|          962|         7|
| suoicilataR|RT @sooky_co: SLA...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|               {Rat}|          0|         3849|         7|
|     SatsuOW|RT @kusujinn: üëª?...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|             {Satsu}|          0|         9787|         4|
|birashoboka7|@Kitona_gold You ...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|       {birashoboka}|          0|            0|        20|
| TheRealCzia|nagugulat ako don...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|{Czia is looking ...|          0|            0|        16|
+------------+--------------------+--------------------+--------------------+--------+----------+--------------------+-----------+-------------+----------+
only showing top 5 rows
</code></pre>
</div>
</div>
<ul class="task-list">
<li><input type="checkbox">Count how many tweet contain the <code>Ukraine</code> hashtag (use the <code>count()</code> action)</li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">filter</span>(array_contains(<span class="st">"hashtags"</span>, <span class="st">"Ukraine"</span>))<span class="op">\</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  .count()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>35</code></pre>
</div>
</div>
</section>
</section>
<section id="user-defined-function" class="level3">
<h3 class="anchored" data-anchor-id="user-defined-function">User defined function</h3>
<p>For more very specific column manipulation you will need Spark‚Äôs <code>udf()</code> function (<em>User Defined Function</em>). It can be useful if Spark does not provide a feature you want. But Spark is a popular and active project, so before coding an udf, go check the documentation. For instance for natural language processing, Spark already has some <a href="https://spark.apache.org/docs/3.1.1/api/python/reference/api/pyspark.ml.feature.Tokenizer.html#pyspark.ml.feature.Tokenizer">functions</a>. Last things, python udf can lead to performance issues (see https://stackoverflow.com/a/38297050) and learning a little bit of scala or java can be a good idea.</p>
<p>For example :</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># !!!! DOES NOT WORK !!!!</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_lower_case(string):</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> string.lower()</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>df.withColumn(<span class="st">"tweet_lower_case"</span>, to_lower_case(df.contenu))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>will just crash. Keep in mind that Spark is a distributed system, and that Python is only installed on the central node, as a convenience to let you execute instructions on the executor nodes. But by default, pure Python functions can only be executed where Python is installed! We need <code>udf()</code> to enable Spark to send Python instructions to the worker nodes.</p>
<p>Let us see how it is done :</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># imports</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> udf</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> explode</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.types <span class="im">import</span> StringType</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co"># pure python functions</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> to_lower_case(string):</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> string.lower()</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="co"># user defined function(we use a lambda function to create the udf)</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>to_lower_case_udf <span class="op">=</span> udf(</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: to_lower_case(x), StringType()</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="co"># df manipulation</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>df_tweet_small<span class="op">\</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  .select(<span class="st">"auteur"</span>,<span class="st">"hashtags"</span>)<span class="op">\</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  .<span class="bu">filter</span>(<span class="st">"size(hashtags)!=0"</span>)<span class="op">\</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  .withColumn(<span class="st">"hashtag"</span>, explode(<span class="st">"hashtags"</span>))<span class="op">\</span></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  .withColumn(<span class="st">"hashtag"</span>, to_lower_case_udf(<span class="st">"hashtag"</span>)).show(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<section id="hands-on-5---user-defined-function" class="level4">
<h4 class="anchored" data-anchor-id="hands-on-5---user-defined-function">‚úçHands-on 5 - User defined function</h4>
<ul class="task-list">
<li><input type="checkbox">Create an user defined function that counts how many words a tweet contains.
<ul>
<li>your function will return an <code>IntegerType</code> and not a <code>StringType</code></li>
</ul></li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># imports</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> udf</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.types <span class="im">import</span> IntegerType</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># pure python functions</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> word_count(string):</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">len</span>(string.split(<span class="st">" "</span>))</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co"># user definid function</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>word_count_udf <span class="op">=</span> udf(</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: word_count(x), IntegerType()</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co"># df manipulation</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>  .withColumn(<span class="st">"word_count"</span>, </span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>              word_count_udf(<span class="st">"contenu"</span>))<span class="op">\</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 19:&gt;                                                         (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------+-------------------------------+--------------------+--------------------+--------+----------+--------------------+-----------+-------------+----------+
|         auteur|                        contenu|       date_creation|            entities|hashtags|like_count|               other|reply_count|retweet_count|word_count|
+---------------+-------------------------------+--------------------+--------------------+--------+----------+--------------------+-----------+-------------+----------+
|    xwendystian|           RT @karlarboledas...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|            {Wüö∂‚Äç‚ôÄÔ∏è}|          0|          962|         7|
|    suoicilataR|           RT @sooky_co: SLA...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|               {Rat}|          0|         3849|         7|
|        SatsuOW|           RT @kusujinn: üëª?...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|             {Satsu}|          0|         9787|         4|
|   birashoboka7|           @Kitona_gold You ...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|       {birashoboka}|          0|            0|        20|
|    TheRealCzia|           nagugulat ako don...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|{Czia is looking ...|          0|            0|        16|
|      bbyindrii|           Keknya ni mata ha...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|                {üé†}|          0|            0|        12|
|          9nns3|„Å™„Çì„ÅãÊ∑±Â§ú2~3ÊôÇ„ÅÆÊ∞óÂàÜ„Å†„Åã„ÇâÂØù„Çã|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|              {·í£·î∞üçê}|          0|            0|         1|
|banbanzai__1140|   @banbanzai_ „Éû„Ç∏„Åß‰ºö„ÅÑ„Åü„ÅÑ„ÄÇ|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|          {„ÇÑ„Åæ„ÇÇ„Çì}|          0|            0|         2|
| Sampathreddyk6|           RT @ynakg2: When ...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|     {Sampathreddyk}|          0|          838|        25|
|ElQueLosCritica|           Uy, el Centro cam...|2022-03-24T14:59:...|{NULL, NULL, NULL...|      []|         0|       {Don Critico}|          0|            0|         8|
+---------------+-------------------------------+--------------------+--------------------+--------+----------+--------------------+-----------+-------------+----------+
only showing top 10 rows
</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="aggregation-functions" class="level2">
<h2 class="anchored" data-anchor-id="aggregation-functions">7. Aggregation functions</h2>
<p>Spark offer a variety of aggregation functions :</p>
<ul>
<li><p><code>count(column : string)</code> will count every not null value of the specify column. You cant use <code>count(1)</code> of <code>count("*")</code> to count every line (even row with only null values)</p></li>
<li><p><code>countDisctinct(column : string)</code> and <code>approx_count_distinct(column : string, percent_error: float)</code>. If the exact number is irrelevant, <code>approx_count_distinct()</code>should be preferred.</p>
<p>Counting distinct elements cannot be done in parallel, and need a lot data transfer. But if you only need an approximation, there is a algorithm, named hyper-log-log (more info <a href="https://databricks.com/fr/blog/2016/05/19/approximate-algorithms-in-apache-spark-hyperloglog-and-quantiles.html">here</a>) that can be parallelized.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> count, countDistinct, approx_count_distinct</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>df.select(count(<span class="st">"col1"</span>)).show()</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>df.select(countDistinct(<span class="st">"col1"</span>)).show()</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>df.select(approx_count_distinct(<span class="st">"col1"</span>), <span class="fl">0.1</span>).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>You have access to all other common functions <code>min()</code>, <code>max()</code>, <code>first()</code>, <code>last()</code>, <code>sum()</code>, <code>sumDistinct()</code>, <code>avg()</code> etc (you should import them first <code>from pyspark.sql.functions import min, max, avg, first, last, sum, sumDistinct</code>)</p></li>
</ul>
<hr>
<section id="hands-on-6---aggregation-functions" class="level3">
<h3 class="anchored" data-anchor-id="hands-on-6---aggregation-functions">‚úçHands-on 6 - Aggregation functions</h3>
<ul class="task-list">
<li><input type="checkbox">What are the min, max, average of <code>interaction_count</code> (use <code>df_tweet_interaction_count</code> created earlier)
<ul>
<li>don‚Äôt forget to import the required functions</li>
</ul></li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="23">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> <span class="bu">min</span>, <span class="bu">max</span>, avg, first, last, <span class="bu">sum</span>, sumDistinct</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>df_tweet_interaction_count<span class="op">\</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  .select(<span class="bu">min</span>(<span class="st">"interaction_count"</span>),</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>          <span class="bu">max</span>(<span class="st">"interaction_count"</span>),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>          avg(<span class="st">"interaction_count"</span>))<span class="op">\</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  .first()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>Row(min(interaction_count)=2, max(interaction_count)=3130, avg(interaction_count)=56.883720930232556)</code></pre>
</div>
</div>
<ul class="task-list">
<li><input type="checkbox">How many tweets have hashtags ?
<ul class="task-list">
<li><input type="checkbox">Distinct hashtags ?</li>
<li><input type="checkbox">Try the approximative count with 0.1 and 0.01 as maximum estimation error allowed.</li>
</ul></li>
</ul>
<div class="cell" data-vscode="{&quot;languageId&quot;:&quot;json&quot;}" data-execution_count="24">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> count, countDistinct, approx_count_distinct</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  .select(count(<span class="st">"hashtags"</span>), </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>          countDistinct(<span class="st">"hashtags"</span>), </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>          approx_count_distinct(<span class="st">"hashtags"</span>, <span class="fl">0.1</span>), </span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>          approx_count_distinct(<span class="st">"hashtags"</span>,<span class="fl">0.01</span>))<span class="op">\</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  .show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 25:&gt;                                                         (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------+------------------------+-------------------------------+-------------------------------+
|count(hashtags)|count(DISTINCT hashtags)|approx_count_distinct(hashtags)|approx_count_distinct(hashtags)|
+---------------+------------------------+-------------------------------+-------------------------------+
|         100000|                    9320|                           7826|                           9342|
+---------------+------------------------+-------------------------------+-------------------------------+
</code></pre>
</div>
</div>
</section>
</section>
<section id="grouping-functions" class="level2">
<h2 class="anchored" data-anchor-id="grouping-functions">8. Grouping functions</h2>
<p>Like SQL you can group row by a criteria with Spark. Just use the <code>groupBy(column : string)</code> method. Then you can compute some aggregation over those groups.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>df<span class="op">\</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  .groupBy(<span class="st">"col1"</span>)<span class="op">\</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  .agg(count(<span class="st">"col2"</span>).alias(<span class="st">"quantity"</span>))\           <span class="co"># alias is use to specify the name of the new column</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  .show() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>agg()</code> method can take multiples argument to compute multiple aggregation at once.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>df<span class="op">\</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  .groupBy(<span class="st">"col1"</span>)<span class="op">\</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  .agg(count(<span class="st">"col2"</span>).alias(<span class="st">"quantity"</span>), </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>       <span class="bu">min</span>(<span class="st">"col2"</span>).alias(<span class="st">"min"</span>), </span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>       avg(<span class="st">"col3"</span>).alias(<span class="st">"avg3"</span>))<span class="op">\</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  .show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Aggregation and grouping transformations work differently than the previous method like <code>filter()</code>, <code>select()</code>, <code>withColumn()</code> etc. Those transformations cannot be run over each partitions in parallel, and need to transfer data between partitions and executors. They are called ‚Äúwide transformations‚Äù</p>
<p><img src="img/spark_exemple2_pipeline.png" style="zoom:50%;"></p>
<section id="hands-on-7---grouping-functions" class="level3">
<h3 class="anchored" data-anchor-id="hands-on-7---grouping-functions">‚úçHands-on 7 - Grouping functions</h3>
<ul class="task-list">
<li><input type="checkbox">Compute a daframe with the min, max and average retweet of each <code>auteur</code>.
<ul>
<li><input type="checkbox">Then order it by the max number of retweet in descending order by .</li>
<li>To do that you can use the following syntax</li>
</ul>
<div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> desc</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>df.orderBy(desc(<span class="st">"col"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.functions <span class="im">import</span> desc</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  .groupBy(<span class="st">"auteur"</span>)<span class="op">\</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  .agg(<span class="bu">min</span>(<span class="st">"retweet_count"</span>).alias(<span class="st">"min_RT"</span>), </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>       <span class="bu">max</span>(<span class="st">"retweet_count"</span>).alias(<span class="st">"max_RT"</span>), </span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>       avg(<span class="st">"retweet_count"</span>).alias(<span class="st">"avg_RT"</span>))<span class="op">\</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  .orderBy(desc(<span class="st">"max_RT"</span>))<span class="op">\</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="spark-sql" class="level2">
<h2 class="anchored" data-anchor-id="spark-sql">9. Spark SQL</h2>
<p>Spark understand SQL statement. It‚Äôs not a hack nor a workaround to use SQL in Spark, it‚Äôs one a the more powerful feature in Spark. To use SQL you will need :</p>
<ol type="1">
<li><p>Register a view pointing to your DataFrame</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>my_df.createOrReplaceTempView(viewName : <span class="bu">str</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
<li><p>Use the sql function</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>spark.sql(<span class="st">"""</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="st">Your SQL statement</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You could manipulate every registered DataFrame by their view name with plain SQL.</p></li>
</ol>
<p>In fact you can do most of this tutorial without any knowledge in PySpark nor Spark.<br>
Many things can only be done in Spark if you know SQL and how to use it in Spark.</p>
<section id="hands-on-8---spark-sql" class="level3">
<h3 class="anchored" data-anchor-id="hands-on-8---spark-sql">‚úçHands-on 8 - Spark SQL</h3>
<ul class="task-list">
<li><input type="checkbox">How many tweets have hashtags ?
<ul class="task-list">
<li><input type="checkbox">Distinct hashtags ?</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>df_tweet<span class="op">\</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  .select(<span class="st">"contenu"</span>, <span class="st">"hashtags"</span>)<span class="op">\</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  .createOrReplaceTempView(<span class="st">"view_hashtag_content"</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>spark.sql(<span class="st">"""</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT COUNT(*), </span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="st">       COUNT(DISTINCT(contenu))</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM view_hashtag_content</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="st"> WHERE size(hashtags) &gt; 0</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)<span class="op">\</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul class="task-list">
<li><input type="checkbox">Compute a dataframe with the min, max and average retweet of each <code>auteur</code> using Spark SQL</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>df_tweet.createOrReplaceTempView(<span class="st">"view_tweet"</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>spark.sql(<span class="st">"""</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT min(retweet_count), </span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="st">       max(retweet_count), </span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="st">       avg(retweet_count)</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="st">  FROM view_tweet</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="st"> GROUP BY auteur</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="st"> ORDER BY MAX(retweet_count) DESC</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>)<span class="op">\</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  .show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="delete-the-jupyter-pyspark-service" class="level1">
<h1>10. Delete the Jupyter-pyspark service</h1>
<ul>
<li><input type="checkbox">Export your notebook
<ul>
<li>Right clic and Download (.ipynb)</li>
<li>File &gt; Save and Export Notebook &gt; HTML</li>
</ul></li>
<li>https://datalab.sspcloud.fr/my-services</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Website built with <a href="https://quarto.org/" target="_blank">Quarto</a><br> <a href="https://github.com/ludo2ne/ENSAI-2A-Big-Data" target="_blank">Source code</a></div>
  </div>
</footer>



</body></html>